<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.5.2 - Gestión de Pedidos Retirados</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* --- CSS PARA BLOQUES DE CÓDIGO (Optimizado) --- */
        .component-body pre {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            background-color: #2d2d2d; 
            color: #ccc;
            white-space: pre-wrap !important;
            overflow-wrap: break-word !important;
        }

        .component-body pre code {
            font-family: 'Fira Code', monospace !important;
            white-space: pre-wrap !important;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.5.2</h1>
            <p>
                Refactorización del flujo de rechazo y manejo de estado "Picked Up" para PedidosYa.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.5.2</p>
            <p><b>Fecha de Despliegue:</b> 23/02/2026</p>
            <p><b>AWS Task:</b> 209</p>
            <p><b>Commits:</b> 72bb7e132084966b102033a155122f540b14b71f</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Redefinir el tratamiento del evento order_picked_up que llega a través del webhook de PedidosYa. Este evento es una notificación en tiempo real que informa que el repartidor (rider) ha retirado físicamente el pedido del local.</p>
              
<p>Impacto: En lugar de generar una nueva novedad de tipo "despacho" (disp_ord) mediante la estrategia SetNews, el sistema ahora realiza una actualización directa y atómica en el registro original de la noticia (News.findOneAndUpdate), marcando el campo orderPickedUp: true.
  </p>
<p>Beneficios:</p>
<p>Precisión de Estado: Refleja con exactitud el hito del retiro del pedido sin duplicar registros en la colección de noticias.
Optimización de Webhooks: El procesamiento del webhook es más ligero al evitar la lógica compleja de creación de nuevas novedades.
Control de Flujo: Establece la base para impedir acciones posteriores (como rechazos por parte de la sucursal) una vez que el pedido ya está en manos del repartidor.
</p>
<p>Conclusión del Archivo: Se optimiza el receptor del webhook para gestionar el retiro del pedido por el repartidor como un cambio de estado interno persistente, mejorando la integridad de los datos del pedido en tiempo real.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <!-- Bloque para api/src/controllers/peya.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/controllers/peya.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Se redefine el tratamiento del evento <code>order_picked_up</code>. En lugar de generar una nueva novedad de tipo "despacho" (que duplicaba registros), ahora se actualiza directamente un campo de estado booleano en el registro de la noticia original.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Actualización Atómica de Estado</h5>
                  <p><b>Explicación:</b> Se reemplaza el uso de la estrategia <code>SetNews</code> por una operación directa sobre la base de datos (<code>findOneAndUpdate</code>). Esto simplifica el flujo, optimiza el webhook y marca de forma persistente que el pedido fue retirado.</p>
                  
                  <b>Código Antes:</b>
                  <pre><code class="language-javascript">
const setNews = new SetNews(req.token);
let newToSet = { typeId: NewsTypeSingleton.idByCod('disp_ord') };
await setNews.setNews(newToSet, req.params.remoteOrderId);
                  </code></pre>
                  
                  <b>Código Después:</b>
                  <pre><code class="language-javascript">
let orderId = req.params.remoteOrderId;
// ... validación ...
await News.findOneAndUpdate({ 'order.id': orderId }, { $set: { orderPickedUp: true } });
                  </code></pre>
              </div>
            </details>

            <!-- Bloque para api/src/models/news.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/models/news.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Actualización del esquema de datos para soportar la nueva lógica de negocio mediante un campo de estado persistente.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Nuevo Campo orderPickedUp</h5>
                  <p><b>Explicación:</b> Se incorpora <code>orderPickedUp</code> (Boolean) al modelo. Esto permite realizar consultas eficientes y verificar el estado del pedido sin recorrer y procesar todo el array histórico de trazas.</p>
                  
                  <b>Código Después:</b>
                  <pre><code class="language-javascript">
	orderPickedUp:{
		type:Boolean,
		default: false,
	}
}, {
	strict: false,
	timestamps: true
});
                  </code></pre>
              </div>
            </details>

            <!-- Bloque para Estrategia de Rechazo -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/management/strategies/orderStrategy/branchRejectStrategy.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Centralización de la lógica de control. La validación crítica que impide el rechazo de pedidos que ya fueron retirados se ha movido desde el controlador específico de la plataforma a la estrategia general de rechazo.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Validación Centralizada de Picked Up</h5>
                  <p><b>Explicación:</b> Antes de procesar un rechazo, la estrategia verifica si <code>this.savedNew.order.orderPickedUp</code> es verdadero. Si es así, se aborta la operación y se registra el evento, protegiendo la integridad del flujo operativo.</p>
                  
                  <b>Código Después:</b>
                  <pre><code class="language-javascript">
// manage() method
this.savedNew = await this.findNew(this.newToSet.id);

if (this.savedNew.order.orderPickedUp === true) {
  Log.saveError(null, {
    message: 'Ignore branchRejectOrder because the order was picked up',
    order: this.savedNew.order,
    platform: 'PedidosYa'
  });
  return resolve();
}

const isValid = this.validateTransition();
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Arquitectura Limpia:</b> Desacoplamiento de reglas de negocio al mover la lógica a la estrategia global.<br>
                  <b>Eficiencia:</b> Las validaciones basadas en campos booleanos directos son mucho más rápidas y seguras.</p>
                </div>
              </div>
            </details>

        </section>
    </div>

    <!-- Scripts de Prism.js para resaltar código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
